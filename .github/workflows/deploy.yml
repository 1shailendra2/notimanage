name: Deploy to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.AZURE_SSH_USER }}
          key: ${{ secrets.AZURE_SSH_KEY }}
          script: |
            # Navigate to project directory (update this if your path is different)
            cd ~/notification || git clone https://github.com/${{ github.repository }} ~/notification && cd ~/notification
            
            # Pull latest code
            git pull origin main
            
            # Install backend dependencies
            npm install
            
            # Install frontend dependencies and build
            cd frontend
            npm install
            npm run build
            cd ..
            
            # Setup environment variables (if they don't exist)
            if [ ! -f .env ]; then
              echo "MONGO_URL=${{ secrets.MONGO_URL }}" > .env
              echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
              echo "PORT=5000" >> .env
            fi
            
            # Restart/Start application with PM2
            pm2 restart notification-system || pm2 start src/server.js --name notification-system
